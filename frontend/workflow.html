<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Glass Tracking – Workflow</title>
    <link rel="stylesheet" href="css/style.css" />

    <style>
        .muted {
            color: #6b7280;
            font-size: 0.85rem;
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 10px;
        }

        .row .input {
            max-width: 280px;
        }

        .list {
            border: 1px solid rgba(226, 232, 240, 0.9);
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
        }

        .list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 10px 12px;
            border-bottom: 1px solid rgba(226, 232, 240, 0.9);
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .item-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .item-title {
            font-weight: 700;
            font-size: 0.92rem;
        }

        .item-sub {
            color: #6b7280;
            font-size: 0.8rem;
        }

        .item-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.8rem;
            background: #f3f4f6;
            border: 1px solid rgba(226, 232, 240, 0.9);
        }

        .danger {
            color: #b91c1c;
        }
    </style>

    <!-- Auth guard (نفس الفكرة من باقي الصفحات) -->

</head>
<script src="js/auth.js"></script>

<body>
    <div class="app-shell">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon"></div>
                <span>Glass Tracking</span>
            </div>

            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item ">
                    <div class="nav-item-icon"></div>
                    <span>Dashboard</span>
                </a>

                <a href="orders.html" class="nav-item">
                    <div class="nav-item-icon"></div>
                    <span>Orders</span>
                </a>

                <a href="live-tracking.html" class="nav-item">
                    <div class="nav-item-icon"></div>
                    <span>Live Tracking</span>
                </a>

                <a href="reports.html" class="nav-item">
                    <div class="nav-item-icon"></div>
                    <span>Reports</span>
                </a>

                <a href="delivery.html" class="nav-item">
                    <div class="nav-item-icon"></div>
                    <span>Delivery</span>
                </a>

                <a href="users.html" class="nav-item">
                    <div class="nav-item-icon"></div>
                    <span>Users</span>
                </a>

                <a href="workflow.html" class="nav-item active">
                    <div class="nav-item-icon"></div>
                    <span>Workflow</span>
                </a>

                <a href="audit.html" class="nav-item ">
                    <div class="nav-item-icon"></div>
                    <span>Audit Log</span>
                </a>

                <a href="settings.html" class="nav-item">
                    <div class="nav-item-icon"></div>
                    <span>Settings</span>
                </a>

                <a href="notifications.html" class="nav-item">
                    <div class="nav-item-icon"></div>
                    <span>Notifications</span>
                    <span class="notif-badge" id="notifBadge" title="Unread notifications">0</span>
                </a>
            </nav>
        </aside>

        <!-- Main -->
        <main class="main">
            <header class="main-header">
                <div>
                    <div class="main-title">Workflow / Stations</div>
                    <div class="main-subtitle">
                        ترتيب محطات المصنع + قائمة أسباب الكسر (للـ Quality & Reports)
                    </div>
                </div>
                <div class="main-header-right">
                    <span class="pill" id="saveStatus">Loaded</span>
                    <button class="btn btn-primary" id="saveBtn">Save</button>
                </div>
            </header>

            <!-- Stages -->
            <section class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Stages (order matters)</div>
                        <div class="card-subtitle">
                            هذا الترتيب هو اللي بيظهر بـ Live Tracking وبيحدد انتقال الزجاج بين المحطات.
                        </div>
                    </div>
                </div>

                <div class="row">
                    <input class="input" id="newStageInput" placeholder="Add new stage (e.g. Washing / Packing)" />
                    <button class="btn btn-primary" id="addStageBtn" type="button">Add stage</button>
                </div>

                <div class="list" id="stagesList"></div>

                <div class="muted" style="margin-top:10px;">
                    استخدم ↑ ↓ لتغيير ترتيب المحطات.
                </div>
            </section>

            <!-- Broken reasons -->
            <section class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Broken reasons</div>
                        <div class="card-subtitle">
                            العامل بيختار سبب الكسر من هون. هيدا بيطلع بالتقارير (حسب السبب/المحطة/العامل/الوقت).
                        </div>
                    </div>
                </div>

                <div class="row">
                    <input class="input" id="newReasonInput" placeholder="Add reason (e.g. Fell on floor)" />
                    <button class="btn btn-primary" id="addReasonBtn" type="button">Add reason</button>
                </div>

                <div class="list" id="reasonsList"></div>

                <div class="muted" style="margin-top:10px;">
                    هالإعدادات محفوظة بالـ Database وبتستعملها صفحات الـ Live Tracking / Quality / Reports.
                </div>
            </section>
        </main>
    </div>

    <script>
        // ====== Auth headers ======
        const token = localStorage.getItem("token");
        function authHeaders() {
            return {
                Authorization: "Bearer " + token,
                "Content-Type": "application/json",
            };
        }

        function safeText(s) {
            return String(s ?? "").replaceAll("<", "&lt;").replaceAll(">", "&gt;");
        }

        const saveBtn = document.getElementById("saveBtn");
        const saveStatus = document.getElementById("saveStatus");

        const newStageInput = document.getElementById("newStageInput");
        const addStageBtn = document.getElementById("addStageBtn");
        const stagesList = document.getElementById("stagesList");

        const newReasonInput = document.getElementById("newReasonInput");
        const addReasonBtn = document.getElementById("addReasonBtn");
        const reasonsList = document.getElementById("reasonsList");

        let STAGES = [];        // [{id,name,isActive}]
        let BROKEN_REASONS = []; // [{id,label,isActive}]
        let dirty = false;

        function markDirty() {
            dirty = true;
            saveStatus.textContent = "Not saved";
        }

        function markSaved() {
            dirty = false;
            saveStatus.textContent = "Saved ✅";
        }

        // ====== Render stages ======
        function renderStages() {
            stagesList.innerHTML = "";

            if (!STAGES.length) {
                stagesList.innerHTML =
                    '<div class="list-item"><div class="muted">No stages defined.</div></div>';
                return;
            }

            STAGES.forEach((st, idx) => {
                const div = document.createElement("div");
                div.className = "list-item";
                div.innerHTML = `
          <div class="item-left">
            <div class="item-title">${safeText(st.name)}</div>
            <div class="item-sub">Position: ${idx + 1}</div>
          </div>
          <div class="item-actions">
            <button class="btn btn-ghost" data-stage-act="up" data-idx="${idx}">↑</button>
            <button class="btn btn-ghost" data-stage-act="down" data-idx="${idx}">↓</button>
            <button class="btn btn-ghost danger" data-stage-act="remove" data-idx="${idx}">Remove</button>
          </div>
        `;
                stagesList.appendChild(div);
            });
        }

        // ====== Render reasons ======
        function renderReasons() {
            reasonsList.innerHTML = "";

            if (!BROKEN_REASONS.length) {
                reasonsList.innerHTML =
                    '<div class="list-item"><div class="muted">No reasons defined.</div></div>';
                return;
            }

            BROKEN_REASONS.forEach((r, idx) => {
                const div = document.createElement("div");
                div.className = "list-item";
                div.innerHTML = `
          <div class="item-left">
            <div class="item-title">${safeText(r.label)}</div>
            <div class="item-sub">Used in Broken Report</div>
          </div>
          <div class="item-actions">
            <button class="btn btn-ghost danger" data-reason-remove="${idx}">Remove</button>
          </div>
        `;
                reasonsList.appendChild(div);
            });
        }

        // ====== Load from server ======
        async function loadWorkflowFromServer() {
            try {
                const res = await fetch("/api/workflow", {
                    method: "GET",
                    headers: authHeaders(),
                });
                const data = await res.json().catch(() => ({}));

                if (!res.ok || !data.ok) {
                    console.error("GET /api/workflow error:", data);
                    saveStatus.textContent = "Error loading";
                    return;
                }

                STAGES = (data.stages || []).map((s) => ({
                    id: s.id,
                    name: s.name,
                    isActive: s.isActive !== false,
                }));

                BROKEN_REASONS = (data.brokenReasons || []).map((r) => ({
                    id: r.id,
                    label: r.label,
                    isActive: r.isActive !== false,
                }));

                renderStages();
                renderReasons();
                markSaved();
            } catch (err) {
                console.error("loadWorkflowFromServer error:", err);
                saveStatus.textContent = "Error loading";
            }
        }

        // ====== Add stage ======
        addStageBtn.addEventListener("click", () => {
            const name = (newStageInput.value || "").trim();
            if (!name) return;

            const exists = STAGES.some(
                (s) => (s.name || "").toLowerCase() === name.toLowerCase()
            );
            if (exists) {
                alert("Stage already exists");
                return;
            }

            STAGES.push({ id: null, name, isActive: true });
            newStageInput.value = "";
            markDirty();
            renderStages();
        });

        // ====== Stage actions (up/down/remove) ======
        stagesList.addEventListener("click", (e) => {
            const btn = e.target.closest("button[data-stage-act]");
            if (!btn) return;
            const act = btn.dataset.stageAct;
            const idx = Number(btn.dataset.idx);
            if (Number.isNaN(idx)) return;

            if (act === "up" && idx > 0) {
                [STAGES[idx - 1], STAGES[idx]] = [STAGES[idx], STAGES[idx - 1]];
                markDirty();
                renderStages();
            }

            if (act === "down" && idx < STAGES.length - 1) {
                [STAGES[idx + 1], STAGES[idx]] = [STAGES[idx], STAGES[idx + 1]];
                markDirty();
                renderStages();
            }

            if (act === "remove") {
                const st = STAGES[idx];
                const ok = confirm(`Remove stage "${st.name}" ?`);
                if (!ok) return;
                STAGES.splice(idx, 1);
                markDirty();
                renderStages();
            }
        });

        // ====== Add reason ======
        addReasonBtn.addEventListener("click", () => {
            const name = (newReasonInput.value || "").trim();
            if (!name) return;

            const exists = BROKEN_REASONS.some(
                (r) => (r.label || "").toLowerCase() === name.toLowerCase()
            );
            if (exists) {
                alert("Reason already exists");
                return;
            }

            BROKEN_REASONS.push({ id: null, label: name, isActive: true });
            newReasonInput.value = "";
            markDirty();
            renderReasons();
        });

        // ====== Remove reason ======
        reasonsList.addEventListener("click", (e) => {
            const btn = e.target.closest("button[data-reason-remove]");
            if (!btn) return;
            const idx = Number(btn.dataset.reasonRemove);
            if (Number.isNaN(idx)) return;

            const r = BROKEN_REASONS[idx];
            const ok = confirm(`Remove reason "${r.label}" ?`);
            if (!ok) return;

            BROKEN_REASONS.splice(idx, 1);
            markDirty();
            renderReasons();
        });

        // ====== Save to server ======
        saveBtn.addEventListener("click", async () => {
            try {
                if (!STAGES.length) {
                    alert("You must have at least 1 stage.");
                    return;
                }

                const payload = {
                    stages: STAGES.map((s) => ({
                        id: s.id || null,
                        name: s.name,
                        isActive: s.isActive !== false,
                    })),
                    brokenReasons: BROKEN_REASONS.map((r) => ({
                        id: r.id || null,
                        label: r.label,
                        isActive: r.isActive !== false,
                    })),
                };

                saveStatus.textContent = "Saving...";
                const res = await fetch("/api/workflow", {
                    method: "POST",
                    headers: authHeaders(),
                    body: JSON.stringify(payload),
                });

                const data = await res.json().catch(() => ({}));

                if (!res.ok || !data.ok) {
                    console.error("POST /api/workflow error:", data);
                    saveStatus.textContent = "Save error";
                    alert("Error while saving workflow");
                    return;
                }

                markSaved();
                // نرجع نعمل load من الـ DB عشان نضمن IDs صحيحة
                await loadWorkflowFromServer();
            } catch (err) {
                console.error("saveWorkflow error:", err);
                saveStatus.textContent = "Save error";
                alert("Internal server error while saving");
            }
        });

        // ====== Warn لو في تعديلات وما تحفظت ======
        window.addEventListener("beforeunload", (e) => {
            if (!dirty) return;
            e.preventDefault();
            e.returnValue = "";
        });

        // ====== Init ======
        loadWorkflowFromServer();
    </script>
</body>

</html>