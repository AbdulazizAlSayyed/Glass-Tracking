<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Glass Tracking – Manager Dashboard</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/manager.css" />

    <script>
        // Auth guard
        (function () {
            const user = JSON.parse(localStorage.getItem("user") || "null");
            const token = localStorage.getItem("token");
            const params = new URLSearchParams(window.location.search);

            if (params.get("logout") === "1") {
                localStorage.removeItem("token");
                localStorage.removeItem("user");
                window.location.replace("/index.html?logout=1");
                return;
            }

            if (!user || !token) {
                window.location.replace("/index.html?logout=1");
                return;
            }

            const current = location.pathname.split("/").pop() || "dashboard.html";
            if (user.homePage && user.homePage !== current) {
                window.location.replace("/" + user.homePage);
                return;
            }
        })();
    </script>
</head>

<body>
    <div class="app-shell">
        <!-- Sidebar (Manager) -->
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon"></div>
                <span>Glass Tracking</span>
            </div>

            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item active">
                    <div class="nav-item-icon"></div>
                    <span>Dashboard</span>
                </a>

                <a href="orders.html" class="nav-item">
                    <div class="nav-item-icon"></div>
                    <span>Orders</span>
                </a>

                <a href="live-tracking.html" class="nav-item">
                    <div class="nav-item-icon"></div>
                    <span>Live Tracking</span>
                </a>

                <a href="reports.html" class="nav-item">
                    <div class="nav-item-icon"></div>
                    <span>Reports</span>
                </a>

                <a href="delivery.html" class="nav-item">
                    <div class="nav-item-icon"></div>
                    <span>Delivery</span>
                </a>

                <a href="users.html" class="nav-item">
                    <div class="nav-item-icon"></div>
                    <span>Users</span>
                </a>

                <a href="workflow.html" class="nav-item">
                    <div class="nav-item-icon"></div>
                    <span>Workflow</span>
                </a>

                <a href="audit.html" class="nav-item">
                    <div class="nav-item-icon"></div>
                    <span>Audit Log</span>
                </a>

                <a href="settings.html" class="nav-item">
                    <div class="nav-item-icon"></div>
                    <span>Settings</span>
                </a>

                <a href="notifications.html" class="nav-item">
                    <div class="nav-item-icon"></div>
                    <span>Notifications</span>
                    <span class="notif-badge" id="notifBadge" title="Unread notifications">0</span>
                </a>
            </nav>
        </aside>

        <!-- Main -->
        <main class="main">
            <header class="main-header">
                <div>
                    <div class="main-title">Manager Overview</div>
                    <div class="main-subtitle">Full production control: orders, stages, breakage, deliveries & audit
                    </div>
                </div>

                <div class="header-actions">
                    <span class="chip" id="chipUser">User: Manager</span>
                    <span class="badge" id="chipFactory">Factory: Tripoli</span>
                    <span class="badge" id="chipLastUpdate">Last update: --:--</span>
                    <button class="btn-icon" id="refreshBtn" type="button">⟳ Refresh</button>
                    <button class="btn btn-primary" type="button" onclick="window.location.href='live-tracking.html'">
                        Open Live Board
                    </button>
                    <button type="button" id="logoutBtn" class="btn btn-ghost">Logout</button>
                </div>
            </header>

            <!-- KPIs -->
            <section class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Today’s KPIs</div>
                        <div class="card-subtitle">Live numbers from backend</div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Orders created today</div>
                        <div class="stat-value" id="kpiOrdersToday">0</div>
                        <div class="stat-chip" id="kpiOrdersTodayChip">—</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-label">Active orders</div>
                        <div class="stat-value" id="kpiActiveOrders">0</div>
                        <div class="stat-chip">In production</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-label">WIP pieces</div>
                        <div class="stat-value" id="kpiWipPieces">0</div>
                        <div class="stat-chip">Across all stages</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-label">Completed today</div>
                        <div class="stat-value" id="kpiCompletedToday">0</div>
                        <div class="stat-chip">Pieces finished</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-label">Broken today</div>
                        <div class="stat-value" id="kpiBrokenToday">0</div>
                        <div class="stat-chip" style="background:#fee2e2; color:#b91c1c;">Track reasons</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-label">Delivery ready</div>
                        <div class="stat-value" id="kpiDeliveryReady">0</div>
                        <div class="stat-chip">Completed orders</div>
                    </div>
                </div>
            </section>

            <!-- Urgent actions -->
            <section class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Urgent actions</div>
                        <div class="card-subtitle">Click to fix issues fast</div>
                    </div>
                </div>

                <div class="quick-grid">
                    <div class="card quick-card">
                        <div class="quick-top">
                            <div>
                                <div class="quick-title">Draft waiting activation</div>
                                <div class="quick-sub">Orders imported but not released</div>
                            </div>
                            <span class="pill blue">Planner</span>
                        </div>
                        <div class="quick-value" id="urgentDraft">0</div>
                        <div class="quick-actions">
                            <button class="btn btn-primary btn-small" type="button"
                                onclick="window.location.href='activation.html'">
                                Open activation
                            </button>
                            <button class="btn btn-ghost btn-small" type="button" onclick="openFilteredOrders('Draft')">
                                View list
                            </button>
                        </div>
                    </div>

                    <div class="card quick-card">
                        <div class="quick-top">
                            <div>
                                <div class="quick-title">Late / at-risk orders</div>
                                <div class="quick-sub">Due date passed and not completed</div>
                            </div>
                            <span class="pill red">Attention</span>
                        </div>
                        <div class="quick-value" id="urgentLate">0</div>
                        <div class="quick-actions">
                            <button class="btn btn-primary btn-small" type="button"
                                onclick="window.location.href='reports.html'">
                                Open report
                            </button>
                            <button class="btn btn-ghost btn-small" type="button"
                                onclick="openFilteredOrders('Delayed')">
                                View list
                            </button>
                        </div>
                    </div>

                    <div class="card quick-card">
                        <div class="quick-top">
                            <div>
                                <div class="quick-title">High breakage stage</div>
                                <div class="quick-sub">Today breakage above threshold</div>
                            </div>
                            <span class="pill orange">Quality</span>
                        </div>
                        <div class="quick-value" id="urgentBreakStage">—</div>
                        <div class="quick-actions">
                            <button class="btn btn-primary btn-small" type="button"
                                onclick="window.location.href='reports.html#broken'">
                                Broken report
                            </button>
                            <button class="btn btn-ghost btn-small" type="button" onclick="scrollToAlerts()">
                                See alerts
                            </button>
                        </div>
                    </div>

                    <div class="card quick-card">
                        <div class="quick-top">
                            <div>
                                <div class="quick-title">Completed orders</div>
                                <div class="quick-sub">Ready to deliver</div>
                            </div>
                            <span class="pill green">Delivery</span>
                        </div>
                        <div class="quick-value" id="urgentReadyDelivery">0</div>
                        <div class="quick-actions">
                            <button class="btn btn-primary btn-small" type="button"
                                onclick="window.location.href='delivery.html'">
                                Open delivery
                            </button>
                            <button class="btn btn-ghost btn-small" type="button"
                                onclick="openFilteredOrders('Completed')">
                                View list
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Recent orders -->
            <section class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Recent orders</div>
                        <div class="card-subtitle">Click “Open” to see progress & timeline</div>
                    </div>
                    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                        <input class="input" id="orderSearch" style="max-width:260px;"
                            placeholder="Search order / client..." />
                        <button class="btn btn-primary" type="button" onclick="window.location.href='orders.html'">View
                            all</button>
                    </div>
                </div>

                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Client</th>
                                <th>Qty</th>
                                <th>Current stage</th>
                                <th>Progress</th>
                                <th>Status</th>
                                <th>Due</th>
                                <th>Last update</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="recentOrdersBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- Stage load + Alerts + Latest activity -->
            <section class="two-col">
                <!-- Stage load -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">Stage load</div>
                            <div class="card-subtitle">Waiting / In progress / Broken today (per stage)</div>
                        </div>
                    </div>

                    <div class="table-wrapper">
                        <table class="table table-compact">
                            <thead>
                                <tr>
                                    <th>Stage</th>
                                    <th>Waiting</th>
                                    <th>In progress</th>
                                    <th>Broken</th>
                                    <th>Load</th>
                                </tr>
                            </thead>
                            <tbody id="stageLoadBody"></tbody>
                        </table>
                    </div>
                </div>

                <div style="display:flex; flex-direction:column; gap:16px;">
                    <!-- Alerts -->
                    <div class="card" id="alertsSection">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Alerts</div>
                                <div class="card-subtitle">Issues that need attention</div>
                            </div>
                            <button class="btn btn-ghost" type="button"
                                onclick="window.location.href='notifications.html'">
                                Open notifications
                            </button>
                        </div>

                        <div class="alerts-list" id="alertsList"></div>
                    </div>

                    <!-- Latest activity -->
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Latest activity</div>
                                <div class="card-subtitle">Mini audit log (who did what)</div>
                            </div>
                            <button class="btn btn-ghost" type="button" onclick="window.location.href='audit.html'">View
                                full audit</button>
                        </div>

                        <div class="table-wrapper">
                            <table class="table table-compact">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>User</th>
                                        <th>Action</th>
                                        <th>Target</th>
                                    </tr>
                                </thead>
                                <tbody id="auditBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Order Details Modal -->
    <div class="modal-backdrop" id="orderModal">
        <div class="modal">
            <div class="modal-header">
                <div>
                    <div class="modal-title" id="modalTitle">Order #---</div>
                    <div style="font-size:0.8rem; color:#6b7280;" id="modalMeta">—</div>
                </div>
                <button class="modal-close" id="modalCloseBtn" type="button">×</button>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                <span class="pill blue" id="modalStatusPill">Status</span>
                <span class="pill" id="modalStagePill">Stage</span>
                <span class="pill" id="modalDuePill">Due</span>
                <span class="pill red" id="modalBrokenPill">Broken</span>
            </div>

            <div class="timeline" id="modalTimeline"></div>
        </div>
    </div>

    <script src="js/manager.js"></script>
</body>

</html>